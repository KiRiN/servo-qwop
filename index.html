<html>

<head>
<script src="/socket.io/socket.io.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script>
    var url = 'http://192.168.11.200:8080';

    var keyCodeMap = {
        "81": 'q',
        "87": 'w',
        "79": 'o',
        "80": 'p',
    };
    var keys = [ 'q', 'w', 'o', 'p' ];
    var keyConfig = {
        q: { axis: 'front_left',  dr:  2 },
        w: { axis: 'front_right', dr:  -2 },
        o: { axis: 'back_left',   dr:  -2 },
        p: { axis: 'back_right',  dr:  2 },
    };
    var limit = {
        front_left:  { min: 2, max: 98 },
        front_right: { min: 2, max: 98 },
        back_left:   { min: 2, max: 98 },
        back_right:  { min: 2, max: 98 },
    };

    var keyState = { q: false, w: false, o: false, p: false };
    var rotation = {
        front_left:  2,
        front_right: 98,
        back_left:   98,
        back_right:  2,
    };

    var updateRotation = function() {
        var updated = false;
        for (var i = 0; i < keys.length; ++i) {
            var key = keys[i];
            var conf = keyConfig[key];
            var axis = conf.axis;

            var rotate;
            if (keyState[key]) {
                rotate = rotation[axis] + conf.dr;
            } else {
                rotate = rotation[axis] - conf.dr;
            }

            if (rotate < limit[axis].min) { rotate = limit[axis].min; }
            if (rotate > limit[axis].max) { rotate = limit[axis].max; }

            if (rotate !== rotation[axis]) {
                updated = true;
            }

            rotation[axis] = rotate;
        }

        return updated;
    };

    var startListeningKeys = function() {
        $(document).on('keydown', function(event) {
            var key = keyCodeMap[ event.keyCode ];
            if (key === 'q' || key === 'w' || key === 'o' || key === 'p') {
                console.log('down: ' + key);
                keyState[key] = true;
            }
        });
        $(document).on('keyup', function(event) {
            var key = keyCodeMap[ event.keyCode ];
            if (key === 'q' || key === 'w' || key === 'o' || key === 'p') {
                console.log('up: ' + key);
                keyState[key] = false;
            }
        });
    };

    var socket = io.connect(url);
    socket.on('connected', function(data) {
        console.log('connected');
        startListeningKeys();
        setInterval(function() {
            var updated = updateRotation();
            if (updated) {
                console.log(JSON.stringify(rotation));
                socket.emit('rotate', rotation);
            }
        }, 20);
    });
    socket.on('response', function(data) {
        console.log('response: ' + JSON.stringify(data));
    });
</script>
</head>

<body>
<div style="font-size: 60px">
    <div>Q: front left</div>
    <div>W: front right</div>
    <div>O: back left  </div>
    <div>P: back right </div>
</div>
</body>

</html>

